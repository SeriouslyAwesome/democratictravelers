DemocraticTravelers.API =
  Host: 'http://api.thedemocratictravelers.com'
  Prefix: '/v1/'
  Base: "<%= Rails.env.production? ? 'http://api.thedemocratictravelers.com/v1' : 'http://api.democratictravelers.dev/v1' %>"
  getJSON: (endpoint, callback) ->
    url = "#{@Base}/#{endpoint}"
    apiKey = $("meta[name='application-name']").attr('data-api-key')
    userId = $("meta[name='application-name']").attr('data-user-id')
    $.ajax url,
      dataType: 'json'
      beforeSend: (xhr) ->
        xhr.setRequestHeader('X-API-KEY', apiKey)
        xhr.setRequestHeader('X-USER-ID', userId)

        DemocraticTravelers.Map.locationsLayer.clearLayers()
        $('.suggestion').not('#new-suggestion').remove()
        $('#map-loading:hidden').fadeIn('fast')
      success: (data, callback) ->
        DemocraticTravelers.Map.renderMarkers data.locations
        DemocraticTravelers.Experience.renderAll data.experiences
      error: (e) ->
        console.log(e)
        return true
      complete: ->
        $('#map-loading:visible').fadeOut('fast')
      statusCode:
        401: ->
          console.log('Login is required.')
        403: ->
          console.log('Not authorized.')
        404: ->
          console.log('Dead link.')
          
  vote: (btn, endpoint) ->
    url = "#{@Base}/#{endpoint}"
    apiKey = $("meta[name='application-name']").attr('data-api-key')
    userId = $("meta[name='application-name']").attr('data-user-id')
    btnClass = $(btn).find('i').attr('class')
    id = $(btn).data('id')

    $.ajax url,
      dataType: 'json'
      type: 'POST'
      beforeSend: (xhr) ->
        xhr.setRequestHeader('X-API-KEY', apiKey)
        xhr.setRequestHeader('X-USER-ID', userId)

        $(btn).find('i').attr('class', 'fa fa-circle-o-notch fa-spin fa-lg')
        $(btn).attr('disabled', 'disabled')
      success: (data, callback) ->
        exp = data.experiences[0]
        html = DemocraticTravelers.Experience.render(exp)
        target = $("[data-experience-id=#{id}]")
        $("[data-experience-id=#{id}]").replaceWith(html)

        # Google Analytics
        label = "#{exp.name} at #{exp.venue} in #{exp.city}, #{exp.state}"
        if btnClass == 'fa fa-thumbs-up fa-lg'
          ga('send', 'event', 'Suggestion', 'Upvote', label)
        else if btnClass == 'fa fa-thumbs-down fa-lg'
          ga('send', 'event', 'Suggestion', 'Downvote', label)

      error: (e) ->
        console.log(e)
        $(btn).removeAttr('disabled')
        $(btn).find('i').attr('class', btnClass)
      statusCode:
        401: ->
          console.log('Login is required.')
        403: ->
          console.log('Not authorized.')
        404: ->
          console.log('Dead link.')